<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Riwayat Transaksi</title>
  <style>
  body {
    font-family: sans-serif;
    padding: 1rem;
  }

  .transaksi {
    margin-bottom: 1rem;
    border-bottom: 1px solid #ccc;
    padding-bottom: 0.5rem;
  }

  /* STYLE UNTUK FILTER PANEL */
  .filter-panel {
    display: flex;
    flex-direction: column; /* force ke bawah */
    gap: 0.75rem;
    margin: 1rem 0;
  }

  .filter-panel label {
    display: flex;
    flex-direction: column;
    font-weight: bold;
  }

  .filter-panel select {
    padding: 0.4rem;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  .filter-panel button {
    padding: 0.5rem;
    font-size: 1rem;
    border: none;
    border-radius: 5px;
    background-color: #444;
    color: white;
    cursor: pointer;
  }

  .filter-panel button:hover {
    background-color: #666;
  }

  @media (min-width: 600px) {
    .filter-panel {
      flex-direction: row;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .filter-panel label {
      flex: 1 1 200px;
    }

    .filter-panel button {
      flex: 0 0 auto;
    }
  }
</style>
</head>
<body>
  <h2>Riwayat Transaksi</h2>
  <a href="index.html">‚Üê Kembali ke Input</a>

  <button onclick="toggleFilter()">üîç Filter</button>

<div id="filterPanel" class="filter-panel" style="display: none;">
  <label>Kategori:
    <select id="filterKategori">
      <option value="">Semua</option>
      <option value="Pulsa">Pulsa</option>
      <option value="Langganan Bstation üíª">Langganan Bstation üíª</option>
    </select>
  </label>

  <label>Akun:
    <select id="filterAkun">
      <option value="">Semua</option>
      <option value="DANA">DANA</option>
      <option value="ShopeePay">ShopeePay</option>
    </select>
  </label>

  <label>Waktu:
    <select id="filterWaktu">
      <option value="all">Semua</option>
      <option value="7">7 Hari Terakhir</option>
      <option value="30">30 Hari Terakhir</option>
    </select>
  </label>

  <button onclick="loadRiwayat()">Terapkan Filter</button>
  <button onclick="resetFilter()">Reset Filter</button>
</div>

  <h3>Edit / Tambah Transaksi</h3>
<form id="form">
  <input type="date" name="tanggal" required />
  <input type="number" name="jumlah" required placeholder="Nominal" />
  <input type="text" name="kategori" placeholder="Kategori" required />
  <input type="text" name="akun" placeholder="Dompet" required />
  <input type="text" name="keterangan" placeholder="Keterangan" />
  <button type="submit">Tambah Transaksi</button>
</form>

  <div id="riwayat">Loading...</div>

  <script>
    let semuaTransaksi = []; // menyimpan semua data transaksi
      let modeEdit = false;
      let idEdit = "";
    const form = document.getElementById("form");
    
    const riwayatDiv = document.getElementById("riwayat");
    const readURL = "https://script.google.com/macros/s/AKfycbxOMNIT1kwZ2g_9ZujurEydk3yyNGHTLuykf4mfNjLkYtv_0IW6Xp0nGHUwIXfPBlvcAQ/exec";

    function toggleFilter() {
      const panel = document.getElementById("filterPanel");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
    }

    function resetFilter() {
      document.getElementById("filterKategori").value = "";
      document.getElementById("filterAkun").value = "";
      document.getElementById("filterWaktu").value = "all";
      loadRiwayat(); // muat ulang semua data
    }

    async function loadRiwayat() {
  try {
    const res = await fetch(readURL);
    const data = await res.json();
    semuaTransaksi = data;

    const filterKategori = document.getElementById("filterKategori").value;
    const filterAkun = document.getElementById("filterAkun").value;
    const filterHari = document.getElementById("filterWaktu").value;

    const now = new Date();

    const hasilFilter = data.filter(row => {
      const [tanggal, kategori, jumlah, akun] = row;
      const tglValid = tanggal ? new Date(tanggal) : null;
      const selisihHari = tglValid ? (now - tglValid) / (1000 * 60 * 60 * 24) : Infinity;

      const cocokTanggal = filterHari === "all" || selisihHari <= parseInt(filterHari);
      const cocokKategori = !filterKategori || kategori === filterKategori;
      const cocokAkun = !filterAkun || akun === filterAkun;

      return cocokTanggal && cocokKategori && cocokAkun;
    });

    if (hasilFilter.length === 0) {
      riwayatDiv.innerHTML = "Tidak ada transaksi yang cocok.";
      return;
    }

    riwayatDiv.innerHTML = hasilFilter.map(row => {
      const [tanggal, kategori, jumlah, akun, keterangan, waktu_input, id_unik] = row;

      const tampilTanggal = tanggal
        ? new Date(tanggal).toLocaleDateString("id-ID", {
            weekday: "long",
            day: "2-digit",
            month: "long",
            year: "numeric"
          })
        : "-";

      const tampilWaktu = waktu_input
        ? new Date(waktu_input).toLocaleString("id-ID", {
            day: "2-digit",
            month: "long",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
            timeZone: "Asia/Jakarta"
          })
        : "-";

      return `
  <div class="transaksi">
    <strong>${tampilTanggal}</strong> - Rp${Number(jumlah).toLocaleString()}<br/>
    <em>${kategori}</em> | ${akun}<br/>
    ${keterangan || "-"}<br/>
    <small>Input: ${tampilWaktu}</small><br/>
    <button onclick="editTransaksi('${id_unik}')">‚úèÔ∏è Edit</button>
  </div>
`;
    }).join("");

  } catch (err) {
    riwayatDiv.innerHTML = "Gagal memuat data: " + err.message;
  }
}

    loadRiwayat();

  function editTransaksi(id) {
  const transaksi = semuaTransaksi.find(row => row[6] === id); // Index ke-6 = ID Unik

  if (!transaksi) {
    alert("Data tidak ditemukan.");
    return;
  }

  const [tanggal, kategori, jumlah, akun, keterangan] = transaksi;

  // Isi ulang form
  form.tanggal.value = tanggal;
  form.jumlah.value = jumlah;
  form.kategori.value = kategori;
  form.akun.value = akun;
  form.keterangan.value = keterangan || "";

  // Aktifkan mode edit
  modeEdit = true;
  idEdit = id;

  // Ubah tulisan tombol submit
  form.querySelector("button[type='submit']").textContent = "Update Transaksi";
}

  </script>
</body>
</html>
