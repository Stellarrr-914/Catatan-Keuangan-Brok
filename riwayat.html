<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Riwayat Transaksi</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    .transaksi { margin-bottom: 1rem; border-bottom: 1px solid #ccc; padding-bottom: 0.5rem; }
  </style>
</head>
<body>
  <h2>Riwayat Transaksi</h2>
  <a href="index.html">‚Üê Kembali ke Input</a>

  <button onclick="toggleFilter()" id="filterBtn">üîç Filter</button>

<div id="filterPanel" style="display:none; margin-top: 1rem;">
  <label>Kategori:
    <select id="filterKategori">
      <option value="">Semua</option>
      <option value="Pulsa">Pulsa</option>
      <option value="Langganan Bstation">Langganan Bstation</option>
      <option value="Budget Pacaran">Budget Pacaran</option>
      <option value="Uang Nganggur">Uang Nganggur</option>
      <option value="Olshop">Olshop</option>
      <option value="Bensin">Bensin</option>
    </select>
  </label>

  <label>Akun:
    <select id="filterAkun">
      <option value="">Semua</option>
      <option value="DANA">DANA</option>
      <option value="SeaBank">SeaBank</option>
      <option value="ShopeePay">ShopeePay</option>
      <option value="GoPay">GoPay</option>
      <option value="Wondr">Wondr</option>
      <!-- isi sesuai akun lo -->
    </select>
  </label>

  <label>Waktu:
    <select id="filterWaktu">
      <option value="all">Semua</option>
      <option value="7">7 Hari Terakhir</option>
      <option value="30">30 Hari Terakhir</option>
    </select>
  </label>

  <button onclick="loadRiwayat()">Terapkan Filter</button>
</div>

  <div id="riwayat">Loading...</div>

  <script>
    const riwayatDiv = document.getElementById("riwayat");
    const readURL = "https://script.google.com/macros/s/AKfycbxOMNIT1kwZ2g_9ZujurEydk3yyNGHTLuykf4mfNjLkYtv_0IW6Xp0nGHUwIXfPBlvcAQ/exec";

    function toggleFilter() {
      const panel = document.getElementById("filterPanel");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
    }


    async function loadRiwayat() {
  try {
    const res = await fetch(readURL);
    const data = await res.json();

    const filterKategori = document.getElementById("filterKategori").value;
    const filterAkun = document.getElementById("filterAkun").value;
    const filterHari = document.getElementById("filterWaktu").value;

    const now = new Date();

    const hasilFilter = data.filter(row => {
      const [tanggal, kategori, jumlah, akun] = row;
      const tglValid = tanggal ? new Date(tanggal) : null;
      const selisihHari = tglValid ? (now - tglValid) / (1000 * 60 * 60 * 24) : Infinity;

      const cocokTanggal = filterHari === "all" || selisihHari <= parseInt(filterHari);
      const cocokKategori = !filterKategori || kategori === filterKategori;
      const cocokAkun = !filterAkun || akun === filterAkun;

      return cocokTanggal && cocokKategori && cocokAkun;
    });

    if (hasilFilter.length === 0) {
      riwayatDiv.innerHTML = "Tidak ada transaksi yang cocok.";
      return;
    }

    riwayatDiv.innerHTML = hasilFilter.map(row => {
      const [tanggal, kategori, jumlah, akun, keterangan, waktu_input] = row;

      const tampilTanggal = tanggal
        ? new Date(tanggal).toLocaleDateString("id-ID", {
            weekday: "long",
            day: "2-digit",
            month: "long",
            year: "numeric"
          })
        : "-";

      const tampilWaktu = waktu_input
        ? new Date(waktu_input).toLocaleString("id-ID", {
            day: "2-digit",
            month: "long",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
            timeZone: "Asia/Jakarta"
          })
        : "-";

      return `
        <div class="transaksi">
          <strong>${tampilTanggal}</strong> - Rp${Number(jumlah).toLocaleString()}<br/>
          <em>${kategori}</em> | ${akun}<br/>
          ${keterangan || "-"}<br/>
          <small>Input: ${tampilWaktu}</small>
        </div>
      `;
    }).join("");

  } catch (err) {
    riwayatDiv.innerHTML = "Gagal memuat data: " + err.message;
  }
}

    loadRiwayat();
  </script>
</body>
</html>
